<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Arkiv ‚Äì AI-Nyheter</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: "class" };</script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<main class="max-w-3xl mx-auto px-4 py-6">

  <!-- Navigering ---------------------------------------------------- -->
  <header class="mb-6 flex items-center gap-4">
    <h1 class="text-2xl font-bold">Arkiv</h1>
    <a href="https://andersasplundberggren.github.io/ai-nyheter-frontend/"
       class="text-indigo-600 hover:underline text-sm">
      ‚Üê Till startsidan
    </a>
  </header>

  <!-- Filter-rad ---------------------------------------------------- -->
  <div class="flex flex-wrap gap-3 mb-6">
    <select id="catSelect"
            class="border rounded px-3 py-1 dark:bg-gray-800 dark:border-gray-600">
      <option value="">Alla kategorier</option>
    </select>

    <input id="search" type="search" placeholder="S√∂k ‚Ä¶"
           class="flex-1 border rounded px-3 py-1 dark:bg-gray-800 dark:border-gray-600" />

    <button id="apply"
            class="px-4 py-1 rounded bg-indigo-600 text-white">
      Filtrera
    </button>
  </div>

  <!-- Loader -------------------------------------------------------- -->
  <div id="loader" class="my-10 flex justify-center">
    <svg class="animate-spin h-8 w-8 text-indigo-600" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4" fill="none"/>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
    </svg>
  </div>

  <!-- Artiklar ------------------------------------------------------ -->
  <div id="list" class="space-y-6"></div>

  <button id="load"
          class="mt-8 px-4 py-2 rounded bg-indigo-600 text-white hidden">
    L√§s in fler
  </button>
</main>


<!-- Huvud-script ---------------------------------------------------- -->
<script>
const API = "https://ai-nyheter-backend.onrender.com/api/archive-sheet";
const PER_PAGE = 40;

let ALL = [];          // hela Sheet-arkivet
let view = [];         // filtrerat resultat
let shown = 0;         // hur m√•nga som redan visas

/* ---------- 1. H√§mta hela arkivet ---------- */
fetch(API)
  .then(r => r.json())
  .then(data => {
    ALL = data;
    initFilters();
    applyFilters();    // f√∂rsta render-omg√•ngen
  })
  .catch(err => {
    console.error(err);
    document.getElementById("loader").remove();
    document.getElementById("list").innerHTML =
      "<p class='text-red-600'>Kunde inte ladda arkivet.</p>";
  });

/* ---------- 2. Fyll kategori-dropdown ---------- */
function initFilters() {
  const sel = document.getElementById("catSelect");
  const cats = [...new Set(ALL.map(a => a.category))].sort();
  sel.innerHTML += cats.map(c => `<option>${c}</option>`).join("");
}

/* ---------- 3. Filtreringsknapp ---------- */
document.getElementById("apply").addEventListener("click", () => {
  shown = 0;
  applyFilters();
});

/* ---------- 4. L√§s-in-fler-knapp ---------- */
document.getElementById("load").addEventListener("click", () => {
  renderMore();
});

/* ---------- 5. Filtrera + rendera ---------- */
function applyFilters() {
  const cat = document.getElementById("catSelect").value.toLowerCase();
  const q   = document.getElementById("search").value.trim().toLowerCase();

  view = ALL.filter(a => {
    const okCat = !cat || a.category.toLowerCase() === cat;
    const txt   = (a.title + a.summary).toLowerCase();
    const okQ   = !q || txt.includes(q);
    return okCat && okQ;
  });

  document.getElementById("list").innerHTML = "";
  renderMore(true);
}

/* ---------- 6. Rendera n√§sta block ---------- */
function renderMore(reset = false) {
  const list   = document.getElementById("list");
  const loader = document.getElementById("loader");
  const button = document.getElementById("load");

  if (reset) shown = 0;
  const slice = view.slice(shown, shown + PER_PAGE);

  slice.forEach(a => {
    list.insertAdjacentHTML("beforeend", `
      <article class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-xs bg-indigo-600 text-white px-2 py-0.5 rounded">
            ${a.category}
          </span>
          ${a.paywall === "1" ? "üîí" : ""}
        </div>
        <h2 class="font-semibold">
          <a href="${a.url}" target="_blank" class="hover:underline">${a.title}</a>
        </h2>
        <time class="text-xs text-gray-500">${a.date}</time>
        <p class="mt-2 text-sm">${a.summary}</p>
      </article>
    `);
  });

  shown += slice.length;
  loader.classList.add("hidden");

  if (shown >= view.length) {
    button.classList.add("hidden");
  } else {
    button.classList.remove("hidden");
  }

  if (!view.length) {
    list.innerHTML = "<p>Inga tr√§ffar.</p>";
    button.classList.add("hidden");
  }
}
</script>
</body>
</html>
