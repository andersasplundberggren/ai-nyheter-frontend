const API = "https://ai-nyheter-backend.onrender.com/api";
let allNews = [];
let shownCount = 0;
const step = 10;

const loader = document.getElementById("loader");
const list = document.getElementById("list");
const loadBtn = document.getElementById("load");
const catSelect = document.getElementById("catSelect");
const searchInput = document.getElementById("search");
const applyBtn = document.getElementById("apply");

// 1. HÃ¤mta alla artiklar + kategorier
Promise.all([
  fetch(`${API}/all`).then(r => r.json()),
  fetch(`${API}/settings`).then(r => r.json())
]).then(([articles, categories]) => {
  allNews = articles;
  loader.classList.add("hidden");
  loadMore();

  // Fyll kategorivÃ¤ljaren
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.Kategori;
    opt.textContent = c.Kategori;
    catSelect.appendChild(opt);
  });
}).catch(err => {
  console.error("Fel vid laddning:", err);
  loader.innerHTML = `<p class="text-red-600">Kunde inte ladda artiklar.</p>`;
});

// 2. Rendera fler artiklar (10 Ã¥t gÃ¥ngen)
function loadMore() {
  const filtered = getFilteredNews();
  const next = filtered.slice(shownCount, shownCount + step);

  next.forEach(n => {
    const article = document.createElement("article");
    article.className = "bg-white dark:bg-gray-800 p-6 rounded-lg shadow";
    article.innerHTML = `
      <div class="flex items-center justify-between mb-1">
        <h3 class="font-semibold">
          ${n.paywall ? "ðŸ”’ " : ""}
          <a href="${n.url}" target="_blank"
             class="text-indigo-600 dark:text-indigo-400 hover:underline">
            ${n.title}
          </a>
        </h3>
        <span class="text-xs bg-indigo-100 dark:bg-indigo-700
                     text-indigo-700 dark:text-indigo-100
                     px-2 py-0.5 rounded">
          ${n.category}
        </span>
      </div>
      <time class="text-xs text-gray-500 dark:text-gray-400">${n.date}</time>
      <p class="mt-2 text-sm">${n.summary}</p>
    `;
    list.appendChild(article);
  });

  shownCount += next.length;
  if (shownCount >= getFilteredNews().length) {
    loadBtn.classList.add("hidden");
  } else {
    loadBtn.classList.remove("hidden");
  }
}

// 3. Filtrera pÃ¥ kategori och sÃ¶kord
function getFilteredNews() {
  const cat = catSelect.value;
  const keyword = searchInput.value.toLowerCase();
  return allNews.filter(n => {
    const matchCat = !cat || n.category === cat;
    const matchText = !keyword || (
      n.title.toLowerCase().includes(keyword) ||
      n.summary.toLowerCase().includes(keyword)
    );
    return matchCat && matchText;
  });
}

// 4. HÃ¤ndelser
loadBtn.addEventListener("click", loadMore);
applyBtn.addEventListener("click", () => {
  shownCount = 0;
  list.innerHTML = "";
  loadMore();
});
